name: CI

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format:
    name: SwiftFormat Check
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftFormat
        run: |
          brew install swiftformat

      - name: Run SwiftFormat
        run: |
          swiftformat --lint . --reporter github-actions-log

  lint:
    name: SwiftLint Check
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: |
          brew install swiftlint

      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging

      - name: Run SwiftLint (Strict)
        run: |
          swiftlint lint --strict --reporter github-actions-logging
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || format('origin/{0}', github.event.repository.default_branch) }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true  # Don't fail on scanning issues

      - name: GitGuardian Scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true  # Don't fail if API key not set

  build-and-test:
    name: Build and Test
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build
        run: |
          xcodebuild build \
            -project Heauton/Heauton.xcodeproj \
            -scheme Heauton \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Debug \
            -quiet

      - name: Run Tests
        run: |
          # Find and use the first available iOS simulator
          # List all available devices and find an iPhone simulator
          SIMULATOR_INFO=$(xcrun simctl list devices available iPhone | grep -m 1 "iPhone" | head -1)

          if [ -z "$SIMULATOR_INFO" ]; then
            echo "No iPhone simulator found, trying any iOS device..."
            SIMULATOR_INFO=$(xcrun simctl list devices available | grep "iOS" | grep -v "unavailable" | head -1)
          fi

          # Extract UDID from the simulator info
          UDID=$(echo "$SIMULATOR_INFO" | grep -o '([A-F0-9-]\{36\})' | tr -d '()')

          if [ -z "$UDID" ]; then
            echo "ERROR: No iOS simulator found!"
            echo "Available devices:"
            xcrun simctl list devices available
            exit 1
          fi

          echo "Using simulator: $SIMULATOR_INFO"
          echo "UDID: $UDID"

          xcodebuild test \
            -project Heauton/Heauton.xcodeproj \
            -scheme Heauton \
            -destination "platform=iOS Simulator,id=$UDID" \
            -configuration Debug \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult

      - name: Generate Code Coverage Report
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json
          xcrun xccov view --report TestResults.xcresult

      - name: Check Code Coverage Threshold
        run: |
          COVERAGE=$(xcrun xccov view --report --json TestResults.xcresult | \
            python3 -c "import sys, json; \
            data = json.load(sys.stdin); \
            print(f\"{data['lineCoverage'] * 100:.2f}\")")
          echo "Code Coverage: $COVERAGE%"

          THRESHOLD=25.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "WARNING: Code coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
            echo "::warning::Code coverage is below the recommended threshold"
          else
            echo "Code coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
          fi

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            TestResults.xcresult
            coverage.json

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.xcresult

  unused-code:
    name: Periphery (Unused Code Detection)
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Periphery
        run: |
          brew install periphery

      - name: Run Periphery
        run: |
          periphery scan \
            --project Heauton/Heauton.xcodeproj \
            --schemes Heauton \
            --targets Heauton \
            --format xcode \
            --skip-build
        continue-on-error: true  # Don't fail build on unused code

      - name: Generate Periphery Report
        if: always()
        run: |
          periphery scan \
            --project Heauton/Heauton.xcodeproj \
            --schemes Heauton \
            --targets Heauton \
            --format json \
            --skip-build > periphery-report.json || true

      - name: Upload Periphery Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: periphery-report
          path: periphery-report.json

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format, lint, security, build-and-test, unused-code]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SwiftFormat | ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SwiftLint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unused Code | ${{ needs.unused-code.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: |
          needs.format.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.build-and-test.result == 'failure'
        run: exit 1
